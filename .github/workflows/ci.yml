name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  cpp-tests:
    name: C++ unit + integration (CMake/CTest)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache CMake build dir
        uses: actions/cache@v4
        with:
          path: build
          key: ${{ runner.os }}-cmake-build-${{ hashFiles('**/CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-cmake-build-

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build gcc g++

      - name: Configure (CMake)
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build

      - name: Run unit tests (bytecode_loader/heap/value/vm)
        working-directory: build
        run: |
          ctest --output-on-failure -C Release -R "^(bytecode_loader_test|heap_test|value_test|vm_test)$" || (
            echo "Unit tests not found by CTest. Available tests:" && ctest -N && exit 1
          )

      - name: Run integration tests (bytecode_vm/error_handling/real_file)
        working-directory: build
        run: |
          ctest --output-on-failure -C Release -R "^(bytecode_vm_test|error_handling_test|real_file_test)$" || (
            echo "Integration tests not found by CTest. Available tests:" && ctest -N && exit 1
          )

      - name: Upload C++ test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cpp-test-reports
          path: |
            build/Testing
            build/**/Testing

  java-tests:
    name: Java tests (lang/lexer) (Gradle)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle

      - name: Ensure Gradle wrapper executable and jar
        run: |
          if [[ -f "./gradlew" ]]; then chmod +x ./gradlew; fi
          if [[ ! -f "gradle/wrapper/gradle-wrapper.jar" ]]; then
            mkdir -p gradle/wrapper
            wget -q https://services.gradle.org/distributions/gradle-8.10.2-wrapper.jar -O gradle/wrapper/gradle-wrapper.jar
          fi

      - name: Show env / Gradle info
        run: |
          java -version
          ./gradlew --version

      - name: Run only lang.lexer tests
        run: |
          ./gradlew test --tests "lang.lexer.*" --no-daemon --console=plain --info --stacktrace

      - name: Upload Java test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: java-test-reports
          path: |
            build/reports/tests/test
            build/test-results/test

  e2e:
    name: E2E (Python)
    runs-on: ubuntu-latest
    needs: [cpp-tests, java-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Run e2e
        run: |
          python e2e/test_compiler.py
